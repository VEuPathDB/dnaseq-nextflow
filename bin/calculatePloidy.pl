#!/usr/bin/perl

use ApiCommonData::Load::CalculationsForCNVs;
use strict;
use warnings;
use Getopt::Long;
use Data::Dumper;

# get parameter values
my $outputDir;
my $fpkm;
my $ploidy = 2;
my $sampleName;
my $taxonId;
my $geneFootprintFile;

&GetOptions("outputDir|o=s" => \$outputDir,
            "fpkmFile|f=s" => \$fpkm,
            "ploidy|p=i" => \$ploidy,
            "sampleName|s=s" => \$sampleName,
            "taxonId|s=i" => \$taxonId,
            "geneFootprints|f=s" => \$geneFootprintFile,
            );

&usage() unless ($outputDir && $fpkm && $sampleName && $taxonId && $geneFootprintFile);

die "File of gene footprints $geneFootprintFile not found\n" unless (-e $geneFootprintFile);

die "File of FPKM values $fpkm not found\n" unless (-e $fpkm); 

my $chrPloidies = &calculateChrPloidies ($geneFootprintFile, $fpkm, $ploidy, $taxonId);

open (OUT, ">$outputDir/$sampleName\_Ploidy.txt") or die "Cannot open $outputDir/$sampleName\_Ploidy.tsv for writing\n$!\n";
printf OUT "na_sequence_id\tchr_copy_number\n";
foreach my $chr (keys %{$chrPloidies}) {
    printf OUT "%s\t%d\n", $chr, $chrPloidies->{$chr};
}
close OUT;

sub calculateChrPloidies {
    my ($geneFootprintFile, $fpkmFile, $ploidy, $taxonId) = @_;
    my $chrs = ApiCommonData::Load::getChrsForCalcs($taxonId);
    my $geneData = ApiCommonData::Load::getGeneInfo($geneFootprintFile, $chrs);
    my $chrValues = ApiCommonData::Load::getChrFPKMVals($fpkmFile, $chrs, $geneData);
    my $chrMedians = ApiCommonData::Load::getChrMedians($chrValues, $chrs);
    my $allChrMedian = ApiCommonData::Load::getMedianAcrossChrs($chrValues, $chrs);
    my $chrPloidies = ApiCommonData::Load::getChrPloidies ($chrMedians, $allChrMedian, $ploidy, $chrs);
    return $chrPloidies;
}
    
sub usage {
    print STDERR "calculatePloidy --outputDir=s <dir to write output> --fpkm File=s <full path to genes.fpkm_tracking file generated by Cufflinks> --sampleName=s <sampleName used to name output files> --taxonId <taxonId for organism> --geneFootprints <gene footprint file> [--ploidy=i <base ploidy> (expected ploidy for the majority of chromosomes - default is 2)]\n";
    exit;
}
exit;
